# 数据建模6步骤期望产出标准

## 概述

本文档基于总结.md文件中的数据建模流程，结合JSON示例文件，为RAG系统中数据建模的6个步骤定义期望的产出标准。这些标准将作为衡量其他文件处理结果正确性的基准。

## 数据建模流程概述

数据建模为知识检索提供数据保障，包含以下6个步骤：
1. 基于Unstructured库实现内容提取
2. 将提取的内容按照JSON格式格式化  
3. 向量化：解析JSON数据构建向量化单元
4. 倒排索引：解析JSON数据构建索引到OpenSearch
5. 知识图谱：解析JSON数据进行实体识别和关系抽取
6. 保存元数据到MySQL

---

## 步骤1：基于Unstructured库的内容提取

### 目标
从PDF等文档中提取文本、图片、图表、表格、位置信息、结构信息等详细内容。

### 期望产出：原始结构化数据

```json
{
  "raw_elements": [
    {
      "element_id": "title_t1", 
      "type": "Title",
      "text": "CHO细胞宿主蛋白检测试剂盒 产品单页",
      "coordinates": [[168, 476], [1490, 476]],
      "page_number": 1,
      "metadata": {"category": "title"}
    },
    {
      "element_id": "para_p2",
      "type": "NarrativeText", 
      "text": "CHO 细胞 HCP（宿主蛋白）残留检测试剂盒旨在对由中国仓鼠卵巢细胞...",
      "coordinates": [[114, 188], [1558, 188]],
      "page_number": 2,
      "metadata": {"category": "paragraph"}
    },
    {
      "element_id": "tbl_8",
      "type": "Table",
      "text": "缓冲液系统 加标 20ng/ml HCP 标准样品的实测浓度...",
      "coordinates": [[168, 837], [1432, 837]], 
      "page_number": 3,
      "metadata": {"rows": 3, "cols": 4}
    },
    {
      "element_id": "fig_3",
      "type": "Image",
      "text": "CHO细胞宿主蛋白检测试剂盒(即用型)",
      "coordinates": [[358, 822], [1348, 822]],
      "page_number": 2,
      "metadata": {"image_path": "figures/20250815_130547_05dc_page002_img03_20250815_130654.jpg"}
    }
  ]
}
```

### 质量要求
- 准确识别文档元素类型（Title、NarrativeText、Table、Image等）
- 保留精确的位置坐标信息
- 提取完整的文本内容
- 为图片元素保存图片路径

---

## 步骤2：JSON格式化

### 目标
将提取的内容按照项目要求的JSON格式进行结构化组织。

### 期望产出：分层JSON结构
基于示例文件`20250815_130547_05dc2896_doc_6.json`的格式：

```json
{
  "document_info": {
    "document_id": 6,
    "source_file": "/path/to/source.pdf",
    "filename": "document.pdf",
    "extraction_time": "2025-08-15T13:06:54.936232",
    "total_sections": 10
  },
  "sections": [
    {
      "section_id": "unique_section_id",
      "title": "section_title",
      "page_start": 1,
      "page_end": 1,
      "blocks": [
        {
          "order": 1,
          "elem_id": "element_id",
          "type": "title|paragraph|figure|table",
          "page": 1,
          "bbox": [[x1, y1], [x2, y2]],
          "text": "element_content"
        }
      ],
      "full_text": "concatenated_text_of_all_blocks",
      "elem_ids": ["elem_id1", "elem_id2"]
    }
  ]
}
```

### 质量要求
- 按标题自动分组形成sections
- 维护元素在section内的顺序
- 生成唯一的section_id和elem_id
- 聚合section的完整文本内容

---

## 步骤3：向量化

### 目标
解析JSON数据构建向量化单元，使用768维嵌入模型进行向量化。

### 期望产出：向量化单元

```json
{
  "vectors": [
    {
      "unit_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003_title",
      "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003",
      "unit_type": "title",
      "text": "产品说明",
      "vector": [0.123, -0.456, 0.789, ...], // 768维向量
      "vector_dim": 768,
      "embedding_model": "sentence-transformers/paraphrase-multilingual-mpnet-base-v2"
    },
    {
      "unit_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003_para",
      "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003", 
      "unit_type": "paragraph",
      "text": "CHO 细胞 HCP（宿主蛋白）残留检测试剂盒旨在对由中国仓鼠卵巢细胞...",
      "vector": [0.234, -0.567, 0.890, ...],
      "vector_dim": 768,
      "embedding_model": "sentence-transformers/paraphrase-multilingual-mpnet-base-v2"
    }
  ]
}
```

### 质量要求
- 为每个文本单元生成唯一的unit_id
- 使用一致的嵌入模型（768维）
- 保留原始文本内容便于检索
- 维护与section的关联关系

---

## 步骤4：倒排索引（OpenSearch）

### 目标
解析JSON数据构建搜索索引，支持BM25检索。

### 期望产出：搜索索引结构

```json
{
  "index_name": "documents_index",
  "documents": [
    {
      "doc_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003",
      "title": "产品说明",
      "content": "CHO 细胞 HCP（宿主蛋白）残留检测试剂盒旨在对由中国仓鼠卵巢细胞...",
      "keywords": ["CHO细胞", "宿主蛋白", "HCP", "检测试剂盒", "抗体", "质量控制"],
      "document_id": 6,
      "filename": "20250815_130547_05dc2896.pdf",
      "page_range": "2-2",
      "section_type": "product_description",
      "boost_fields": {
        "title": 3.0,
        "keywords": 2.0, 
        "content": 1.0
      }
    }
  ]
}
```

### 质量要求
- 提取关键词用于增强检索
- 设置合理的字段权重boost
- 包含文档元信息（文件名、页码范围等）
- 支持多字段联合搜索

---

## 步骤5：知识图谱

### 目标
解析JSON数据进行规则锚点识别、NER实体识别、实体链接、关系抽取，并保存到Neo4j。

### 期望产出：实体关系结构

```json
{
  "entities": [
    {
      "entity_id": "CHO细胞宿主蛋白检测试剂盒",
      "entity_type": "产品",
      "entity_value": "CHO细胞宿主蛋白检测试剂盒", 
      "source_section": "20250815_130547_05dc2896_doc#2025-08-15#6_0002",
      "confidence": 0.95,
      "attributes": {
        "产品类型": "检测试剂盒",
        "检测对象": "宿主蛋白",
        "细胞类型": "CHO细胞"
      }
    },
    {
      "entity_id": "CHO-K1细胞系",
      "entity_type": "细胞系",
      "entity_value": "CHO-K1细胞系",
      "source_section": "20250815_130547_05dc2896_doc#2025-08-15#6_0003", 
      "confidence": 0.92,
      "attributes": {
        "物种来源": "中国仓鼠卵巢细胞",
        "用途": "生物制品生产"
      }
    }
  ],
  "relationships": [
    {
      "relation_id": "rel_001",
      "source_entity": "CHO细胞宿主蛋白检测试剂盒",
      "target_entity": "CHO-K1细胞系", 
      "relation_type": "检测",
      "confidence": 0.88,
      "source_section": "20250815_130547_05dc2896_doc#2025-08-15#6_0003"
    },
    {
      "relation_id": "rel_002", 
      "source_entity": "HCP",
      "target_entity": "宿主细胞蛋白",
      "relation_type": "等同于",
      "confidence": 0.95,
      "source_section": "20250815_130547_05dc2896_doc#2025-08-15#6_0003"
    }
  ]
}
```

### 质量要求
- 实体识别覆盖产品、技术、指标等关键概念
- 关系抽取体现语义联系
- 规则锚点识别优先级高于NER结果
- 包含置信度评分
- 保留溯源信息

---

## 步骤6：元数据（MySQL）

### 目标
保存文档、段落、元素的元数据信息到关系数据库。

### 期望产出：数据库表结构和数据

#### documents表
```sql
CREATE TABLE documents (
  id INT PRIMARY KEY,
  filename VARCHAR(255),
  source_path VARCHAR(500), 
  extraction_time DATETIME,
  total_sections INT,
  document_type VARCHAR(50),
  file_size BIGINT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO documents VALUES (
  6, 
  '20250815_130547_05dc2896.pdf',
  '/Users/craig-macmini/Documents/my_workspace/py_workspace/GraphRAG/upload/pdf/20250815_130547_05dc2896.pdf',
  '2025-08-15 13:06:54',
  10,
  'product_manual', 
  2048576,
  NOW()
);
```

#### sections表
```sql
CREATE TABLE sections (
  section_id VARCHAR(255) PRIMARY KEY,
  document_id INT,
  title VARCHAR(500),
  page_start INT,
  page_end INT, 
  content_type VARCHAR(50),
  full_text TEXT,
  block_count INT,
  FOREIGN KEY (document_id) REFERENCES documents(id)
);
```

#### elements表
```sql
CREATE TABLE elements (
  elem_id VARCHAR(255) PRIMARY KEY,
  section_id VARCHAR(255),
  element_type ENUM('title','paragraph','figure','table'),
  page_number INT,
  bbox_coords JSON,
  text_content TEXT,
  order_index INT,
  FOREIGN KEY (section_id) REFERENCES sections(section_id)
);
```

### 质量要求
- 维护完整的外键约束关系
- 支持高效的查询检索
- 保存足够的元信息用于溯源
- 数据类型和长度设置合理

---

## 整体质量验证标准

每个步骤的产出都应该满足以下要求：

### 1. 数据完整性
- 不丢失原始文档中的重要信息
- 保持数据在各步骤间的一致性
- 处理异常情况不中断流程

### 2. 结构一致性
- 格式统一，便于下游处理
- 字段命名规范
- 数据类型标准化

### 3. 可追溯性
- 保留源文档和位置信息
- 维护处理链路的完整性
- 支持问题定位和调试

### 4. 类型准确性
- 正确识别文本、图片、表格等类型
- 实体和关系识别准确
- 语义理解正确

### 5. 关联完整性
- 维护section、block、element之间的层级关系
- 保持跨系统数据的一致性
- 支持多维度关联查询

## 应用说明

使用本标准验证其他文件的处理结果时：

1. **对比结构**：检查产出是否包含必需的字段和层级
2. **验证数据**：确认关键信息是否正确提取和转换
3. **测试关联**：验证不同步骤产出间的关联关系
4. **评估质量**：使用质量验证标准进行全面评估

每个步骤的产出都应该为下一步提供充分的数据支撑，最终为知识检索的三路召回（BM25、向量库、知识图谱）提供完整、准确、高质量的数据基础。
