# 知识检索8步骤期望产出标准

## 概述

本文档基于总结.md文件中的知识检索流程，为RAG系统中知识检索的8个步骤定义期望的输入输出标准。知识检索利用数据建模阶段准备的数据，通过多路召回、融合排序等技术实现精准的信息检索。

## 知识检索流程概述

知识检索基于数据建模的产出，包含以下8个步骤：
1. 规范化：处理全角半角、空格标点、同义词标准化、移除低信息词、使用jieba做分词
2. 意图识别：标题问法、内容碎句问法、向量相似度判断
3. 三路候选召回：BM25、向量库、知识图谱
4. 聚合与分数融合（section颗粒度）
5. 重排：使用bge-reranker-large重排模型
6. 扩展：把"一家子"拉齐（同一个section都拿出来）
7. 组装：把文本、表格、图片、图表等信息组装好
8. 流式输出结果

---

## 步骤1：查询规范化

### 目标
对用户输入的查询进行预处理，标准化查询文本，提高后续检索的准确性。

### 输入
```json
{
  "user_query": "CHO细胞宿主蛋白检测试剂盒　的产品特点是什么？",
  "query_id": "query_20250115_001",
  "timestamp": "2025-01-15T10:30:00Z"
}
```

### 期望产出：规范化查询

```json
{
  "normalized_query": {
    "query_id": "query_20250115_001",
    "original_text": "CHO细胞宿主蛋白检测试剂盒　的产品特点是什么？",
    "normalized_text": "CHO细胞宿主蛋白检测试剂盒的产品特点是什么",
    "processing_steps": {
      "full_half_width_conversion": "CHO细胞宿主蛋白检测试剂盒 的产品特点是什么?",
      "punctuation_standardization": "CHO细胞宿主蛋白检测试剂盒的产品特点是什么",
      "synonym_standardization": "CHO细胞宿主蛋白检测试剂盒的产品特点是什么",
      "low_info_word_removal": "CHO细胞宿主蛋白检测试剂盒产品特点",
      "jieba_segmentation": ["CHO", "细胞", "宿主", "蛋白", "检测", "试剂盒", "产品", "特点"]
    },
    "keywords": ["CHO细胞", "宿主蛋白", "检测试剂盒", "产品特点"],
    "query_length": 8,
    "language": "zh"
  }
}
```

### 质量要求
- 正确处理中英文混合文本
- 保留关键信息，去除冗余词汇
- 分词准确，不破坏专业术语
- 同义词映射完整

---

## 步骤2：意图识别

### 目标
识别用户查询的意图类型，为后续检索策略提供指导。

### 输入
```json
{
  "normalized_query": {
    "normalized_text": "CHO细胞宿主蛋白检测试剂盒的产品特点是什么",
    "keywords": ["CHO细胞", "宿主蛋白", "检测试剂盒", "产品特点"]
  }
}
```

### 期望产出：意图识别结果

```json
{
  "intent_analysis": {
    "query_id": "query_20250115_001",
    "intent_types": [
      {
        "intent": "product_feature_inquiry",
        "confidence": 0.92,
        "evidence": ["产品特点", "是什么"],
        "query_pattern": "content_fragment_question"
      },
      {
        "intent": "product_information",
        "confidence": 0.85,
        "evidence": ["CHO细胞宿主蛋白检测试剂盒"],
        "query_pattern": "entity_specific_question"
      }
    ],
    "primary_intent": "product_feature_inquiry",
    "question_type": "what_question",
    "target_entity": "CHO细胞宿主蛋白检测试剂盒",
    "target_attribute": "产品特点",
    "similarity_vectors": {
      "title_similarity": 0.78,
      "content_similarity": 0.84
    },
    "retrieval_strategy": {
      "primary_path": "content_search",
      "secondary_path": "entity_search",
      "boost_fields": ["产品特点", "特点", "优势"]
    }
  }
}
```

### 质量要求
- 准确识别查询意图类型
- 区分标题问法和内容碎句问法
- 提供合理的置信度评分
- 指导后续检索策略

---

## 步骤3：三路候选召回

### 目标
通过BM25、向量库、知识图谱三种检索方式获取候选结果。

### 输入
```json
{
  "intent_analysis": {
    "normalized_text": "CHO细胞宿主蛋白检测试剂盒的产品特点是什么",
    "keywords": ["CHO细胞", "宿主蛋白", "检测试剂盒", "产品特点"],
    "primary_intent": "product_feature_inquiry",
    "target_entity": "CHO细胞宿主蛋白检测试剂盒"
  }
}
```

### 期望产出：三路召回结果

```json
{
  "multi_recall_results": {
    "query_id": "query_20250115_001",
    "bm25_results": [
      {
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
        "title": "产品特点",
        "score": 8.45,
        "matched_terms": ["产品", "特点", "检测", "试剂盒"],
        "source": "bm25",
        "content_snippet": "· 更高的覆盖率 81% （使用 2D Gel/Western Blot 检测）：多宁生物 HCP 检测试剂盒...",
        "document_id": 6,
        "page_range": "2-2"
      },
      {
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003",
        "title": "产品说明", 
        "score": 7.23,
        "matched_terms": ["CHO", "细胞", "宿主", "蛋白"],
        "source": "bm25",
        "content_snippet": "CHO 细胞 HCP（宿主蛋白）残留检测试剂盒旨在对由中国仓鼠卵巢细胞...",
        "document_id": 6,
        "page_range": "2-2"
      }
    ],
    "vector_results": [
      {
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
        "title": "产品特点",
        "score": 0.89,
        "similarity": 0.89,
        "source": "vector",
        "vector_id": "vec_20250815_130547_05dc2896_doc_6_0005",
        "content_snippet": "· 更高的覆盖率 81% （使用 2D Gel/Western Blot 检测）...",
        "document_id": 6,
        "embedding_model": "sentence-transformers/paraphrase-multilingual-mpnet-base-v2"
      },
      {
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003", 
        "title": "产品说明",
        "score": 0.82,
        "similarity": 0.82,
        "source": "vector",
        "vector_id": "vec_20250815_130547_05dc2896_doc_6_0003",
        "content_snippet": "CHO 细胞 HCP（宿主蛋白）残留检测试剂盒旨在对由中国仓鼠卵巢细胞...",
        "document_id": 6,
        "embedding_model": "sentence-transformers/paraphrase-multilingual-mpnet-base-v2"
      }
    ],
    "knowledge_graph_results": [
      {
        "entity_path": ["CHO细胞宿主蛋白检测试剂盒", "具有特点", "高覆盖率"],
        "score": 0.76,
        "source": "knowledge_graph",
        "relation_type": "has_feature",
        "source_section": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
        "entity_attributes": {
          "覆盖率": "81%",
          "检测方法": "2D Gel/Western Blot"
        },
        "confidence": 0.88
      },
      {
        "entity_path": ["CHO细胞宿主蛋白检测试剂盒", "应用于", "CHO-K1细胞系"],
        "score": 0.71,
        "source": "knowledge_graph", 
        "relation_type": "applied_to",
        "source_section": "20250815_130547_05dc2896_doc#2025-08-15#6_0003",
        "entity_attributes": {
          "细胞类型": "中国仓鼠卵巢细胞",
          "应用阶段": "早期或晚期过程开发"
        },
        "confidence": 0.82
      }
    ],
    "recall_stats": {
      "bm25_count": 15,
      "vector_count": 12,
      "kg_count": 8,
      "total_unique_sections": 20,
      "recall_time_ms": 245
    }
  }
}
```

### 质量要求
- 三路召回结果互补，覆盖不同检索需求
- BM25关键词匹配准确
- 向量相似度计算精确
- 知识图谱路径推理合理
- 召回速度满足实时性要求

---

## 步骤4：聚合与分数融合

### 目标
将三路召回结果在section粒度进行聚合，融合不同来源的分数。

### 输入
三路召回的结果（如步骤3的输出）

### 期望产出：融合后的候选列表

```json
{
  "aggregated_results": {
    "query_id": "query_20250115_001",
    "candidates": [
      {
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
        "title": "产品特点",
        "fusion_score": 8.92,
        "source_scores": {
          "bm25_score": 8.45,
          "vector_score": 0.89,
          "kg_score": 0.76
        },
        "normalized_scores": {
          "bm25_normalized": 0.85,
          "vector_normalized": 0.89,
          "kg_normalized": 0.76
        },
        "fusion_weights": {
          "bm25_weight": 0.4,
          "vector_weight": 0.4,
          "kg_weight": 0.2
        },
        "source_coverage": ["bm25", "vector", "knowledge_graph"],
        "document_id": 6,
        "page_range": "2-2",
        "content_preview": "· 更高的覆盖率 81% （使用 2D Gel/Western Blot 检测）：多宁生物 HCP 检测试剂盒所使用的检测抗体..."
      },
      {
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003",
        "title": "产品说明",
        "fusion_score": 7.58,
        "source_scores": {
          "bm25_score": 7.23,
          "vector_score": 0.82,
          "kg_score": 0.71
        },
        "normalized_scores": {
          "bm25_normalized": 0.72,
          "vector_normalized": 0.82,
          "kg_normalized": 0.71
        },
        "fusion_weights": {
          "bm25_weight": 0.4,
          "vector_weight": 0.4,
          "kg_weight": 0.2
        },
        "source_coverage": ["bm25", "vector", "knowledge_graph"],
        "document_id": 6,
        "page_range": "2-2",
        "content_preview": "CHO 细胞 HCP（宿主蛋白）残留检测试剂盒旨在对由中国仓鼠卵巢细胞 CHO-K1 细胞系生产生物制品..."
      }
    ],
    "fusion_strategy": "weighted_sum",
    "total_candidates": 12,
    "aggregation_stats": {
      "sections_with_multi_source": 8,
      "sections_bm25_only": 3,
      "sections_vector_only": 1,
      "fusion_time_ms": 45
    }
  }
}
```

### 质量要求
- 分数归一化合理，便于比较
- 融合权重根据查询类型动态调整
- section级别聚合避免重复
- 保留多源支撑信息

---

## 步骤5：重排序

### 目标
使用bge-reranker-large重排模型对候选结果进行精确排序。

### 输入
聚合融合后的候选列表

### 期望产出：重排序结果

```json
{
  "reranked_results": {
    "query_id": "query_20250115_001",
    "query_text": "CHO细胞宿主蛋白检测试剂盒的产品特点是什么",
    "reranked_candidates": [
      {
        "rank": 1,
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
        "title": "产品特点",
        "rerank_score": 0.94,
        "original_fusion_score": 8.92,
        "rerank_confidence": 0.91,
        "relevance_explanation": "直接回答产品特点问题，内容高度相关",
        "content_preview": "· 更高的覆盖率 81% （使用 2D Gel/Western Blot 检测）：多宁生物 HCP 检测试剂盒...",
        "document_id": 6,
        "page_range": "2-2"
      },
      {
        "rank": 2,
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0007",
        "title": "案例分享", 
        "rerank_score": 0.78,
        "original_fusion_score": 6.23,
        "rerank_confidence": 0.82,
        "relevance_explanation": "包含产品特点的实际验证数据和对比分析",
        "content_preview": "· 图中蓝框内是多宁抗体和市面上主流试剂盒中的抗体共同识别的宿主细胞蛋白斑点...",
        "document_id": 6,
        "page_range": "2-2"
      },
      {
        "rank": 3,
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0003",
        "title": "产品说明",
        "rerank_score": 0.72,
        "original_fusion_score": 7.58,
        "rerank_confidence": 0.75,
        "relevance_explanation": "包含产品基本信息，但主要侧重功能说明而非特点",
        "content_preview": "CHO 细胞 HCP（宿主蛋白）残留检测试剂盒旨在对由中国仓鼠卵巢细胞...",
        "document_id": 6,
        "page_range": "2-2"
      }
    ],
    "reranker_model": "bge-reranker-large",
    "rerank_time_ms": 156,
    "score_distribution": {
      "high_relevance": 1,
      "medium_relevance": 2,
      "low_relevance": 0
    }
  }
}
```

### 质量要求
- 重排序结果与查询相关性更高
- 提供排序置信度和解释
- 处理速度满足实时性要求
- 模型输出稳定可靠

---

## 步骤6：结果扩展

### 目标
将"一家子"拉齐，即将同一个section的相关内容都包含进来。

### 输入
重排序后的结果

### 期望产出：扩展后的完整结果

```json
{
  "expanded_results": {
    "query_id": "query_20250115_001",
    "expanded_sections": [
      {
        "primary_section": {
          "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
          "title": "产品特点",
          "rank": 1,
          "rerank_score": 0.94
        },
        "complete_section_content": {
          "full_text": "产品特点\n· 更高的覆盖率 81% （使用 2D Gel/Western Blot 检测）：多宁生物 HCP 检测试剂盒所使用的检测抗体，对于不同大小，不同等 电点的宿主细胞蛋白均有更加广泛的识别效率。经过 2D 电泳和 Western Blot 检测，覆盖率可达 80% 以上。\nCHO细胞宿主蛋白检测试剂盒(即用型)\n· 批次稳定性好 , 持续供应佳 , 减少了频繁桥接带来的不便。\n· 拥有多例国内外 IND 申报成功案例 , 是您做放行检测的不二之选。",
          "blocks": [
            {
              "elem_id": "title_t1",
              "type": "title",
              "text": "产品特点",
              "page": 2,
              "bbox": [[112, 705], [225, 705]]
            },
            {
              "elem_id": "para_p2", 
              "type": "paragraph",
              "text": "· 更高的覆盖率 81% （使用 2D Gel/Western Blot 检测）：多宁生物 HCP 检测试剂盒所使用的检测抗体，对于不同大小，不同等 电点的宿主细胞蛋白均有更加广泛的识别效率。经过 2D 电泳和 Western Blot 检测，覆盖率可达 80% 以上。",
              "page": 2,
              "bbox": [[114, 754], [1555, 754]]
            },
            {
              "elem_id": "fig_3",
              "type": "figure", 
              "text": "CHO细胞宿主蛋白检测试剂盒(即用型)",
              "caption": "CHO细胞宿主蛋白检测试剂盒(即用型)",
              "image_path": "figures/20250815_130547_05dc_page002_img03_20250815_130654.jpg",
              "page": 2,
              "bbox": [[358, 822], [1348, 822]]
            },
            {
              "elem_id": "para_p4",
              "type": "paragraph",
              "text": "· 批次稳定性好 , 持续供应佳 , 减少了频繁桥接带来的不便。",
              "page": 2,
              "bbox": [[154, 849], [823, 849]]
            },
            {
              "elem_id": "para_p5",
              "type": "paragraph", 
              "text": "· 拥有多例国内外 IND 申报成功案例 , 是您做放行检测的不二之选。",
              "page": 2,
              "bbox": [[159, 896], [909, 896]]
            }
          ]
        },
        "related_sections": [],
        "document_info": {
          "document_id": 6,
          "filename": "20250815_130547_05dc2896.pdf",
          "page_range": "2-2"
        }
      }
    ],
    "expansion_strategy": "complete_section",
    "total_expanded_sections": 3,
    "expansion_time_ms": 32
  }
}
```

### 质量要求
- 确保section内容完整性
- 保持原有的结构和顺序
- 包含所有类型的元素（文本、图片、表格）
- 维护元素间的关联关系

---

## 步骤7：内容组装

### 目标
将文本、表格、图片、图表等信息按照合适的格式组装，准备最终输出。

### 输入
扩展后的完整结果

### 期望产出：组装后的结构化内容

```json
{
  "assembled_content": {
    "query_id": "query_20250115_001",
    "response_sections": [
      {
        "section_rank": 1,
        "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
        "section_title": "产品特点",
        "relevance_score": 0.94,
        "assembled_blocks": [
          {
            "block_type": "text_block",
            "content": {
              "title": "产品特点",
              "paragraphs": [
                "更高的覆盖率 81%（使用 2D Gel/Western Blot 检测）：多宁生物 HCP 检测试剂盒所使用的检测抗体，对于不同大小，不同等电点的宿主细胞蛋白均有更加广泛的识别效率。经过 2D 电泳和 Western Blot 检测，覆盖率可达 80% 以上。",
                "批次稳定性好，持续供应佳，减少了频繁桥接带来的不便。",
                "拥有多例国内外 IND 申报成功案例，是您做放行检测的不二之选。"
              ]
            },
            "formatting": {
              "bullet_points": true,
              "highlight_keywords": ["覆盖率", "81%", "稳定性", "IND申报"]
            }
          },
          {
            "block_type": "image_block",
            "content": {
              "image_path": "figures/20250815_130547_05dc_page002_img03_20250815_130654.jpg",
              "caption": "CHO细胞宿主蛋白检测试剂盒(即用型)",
              "alt_text": "产品包装图片展示即用型检测试剂盒",
              "display_size": "medium"
            },
            "position": "inline"
          }
        ],
        "source_info": {
          "document": "20250815_130547_05dc2896.pdf",
          "page": 2,
          "confidence": 0.94
        }
      }
    ],
    "content_summary": {
      "total_text_blocks": 1,
      "total_image_blocks": 1,
      "total_table_blocks": 0,
      "total_sections": 1,
      "answer_completeness": 0.92
    },
    "assembly_metadata": {
      "assembly_time_ms": 78,
      "content_length": 245,
      "media_count": 1,
      "formatting_applied": ["bullet_points", "keyword_highlighting"]
    }
  }
}
```

### 质量要求
- 内容格式清晰易读
- 多媒体元素正确引用
- 保持信息的完整性和准确性
- 适合流式输出格式

---

## 步骤8：流式输出

### 目标
将组装好的内容以流式方式输出，提供实时的用户体验。

### 输入
组装后的结构化内容

### 期望产出：流式输出数据流

```json
{
  "stream_output": {
    "query_id": "query_20250115_001",
    "stream_chunks": [
      {
        "chunk_id": 1,
        "chunk_type": "response_start",
        "content": {
          "message": "根据文档内容，CHO细胞宿主蛋白检测试剂盒的主要产品特点包括：",
          "total_sections": 1,
          "estimated_length": 245
        },
        "timestamp": "2025-01-15T10:30:01.234Z"
      },
      {
        "chunk_id": 2,
        "chunk_type": "text_content",
        "content": {
          "text": "**1. 更高的覆盖率**\n- 覆盖率达到81%（通过2D Gel/Western Blot检测验证）\n- 检测抗体对不同大小、不同等电点的宿主细胞蛋白都有广泛的识别效率\n- 经过2D电泳和Western Blot检测，覆盖率可达80%以上",
          "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
          "formatting": "markdown"
        },
        "timestamp": "2025-01-15T10:30:01.456Z"
      },
      {
        "chunk_id": 3,
        "chunk_type": "text_content", 
        "content": {
          "text": "**2. 批次稳定性好**\n- 持续供应能力强\n- 减少了频繁桥接带来的不便",
          "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005",
          "formatting": "markdown"
        },
        "timestamp": "2025-01-15T10:30:01.678Z"
      },
      {
        "chunk_id": 4,
        "chunk_type": "text_content",
        "content": {
          "text": "**3. 权威认可**\n- 拥有多例国内外IND申报成功案例\n- 是放行检测的优选方案",
          "section_id": "20250815_130547_05dc2896_doc#2025-08-15#6_0005", 
          "formatting": "markdown"
        },
        "timestamp": "2025-01-15T10:30:01.890Z"
      },
      {
        "chunk_id": 5,
        "chunk_type": "media_content",
        "content": {
          "media_type": "image",
          "media_url": "figures/20250815_130547_05dc_page002_img03_20250815_130654.jpg",
          "caption": "CHO细胞宿主蛋白检测试剂盒(即用型)",
          "description": "产品包装展示图"
        },
        "timestamp": "2025-01-15T10:30:02.123Z"
      },
      {
        "chunk_id": 6,
        "chunk_type": "source_citation",
        "content": {
          "source_document": "20250815_130547_05dc2896.pdf",
          "source_page": 2,
          "section_title": "产品特点",
          "confidence": 0.94
        },
        "timestamp": "2025-01-15T10:30:02.345Z"
      },
      {
        "chunk_id": 7,
        "chunk_type": "response_end",
        "content": {
          "message": "以上信息来源于产品技术文档，详细内容请参考原始文档。",
          "total_chunks": 7,
          "response_complete": true
        },
        "timestamp": "2025-01-15T10:30:02.567Z"
      }
    ],
    "stream_metadata": {
      "total_chunks": 7,
      "streaming_duration_ms": 1333,
      "average_chunk_interval_ms": 190,
      "final_content_length": 245
    }
  }
}
```

### 质量要求
- 流式输出稳定，无中断
- 分块大小合理，用户体验好
- 内容格式保持一致性
- 包含完整的溯源信息

---

## 整体质量验证标准

### 1. 检索准确性
- 召回相关内容的完整性
- 排序结果的相关性
- 多路召回的互补性

### 2. 响应速度
- 单步处理时间合理
- 端到端响应时间满足实时性
- 流式输出无延迟

### 3. 内容质量  
- 信息准确性和完整性
- 格式规范统一
- 多媒体内容正确展示

### 4. 用户体验
- 回答直接相关
- 内容结构清晰
- 溯源信息完整

### 5. 系统稳定性
- 异常情况处理
- 并发请求支持
- 资源使用合理

## 应用说明

使用本标准验证知识检索系统时：

1. **步骤验证**：检查每个步骤的输入输出是否符合标准
2. **流程完整性**：确认8个步骤能够正常串联
3. **性能评估**：验证响应时间和准确性指标
4. **质量评估**：使用质量标准进行全面评估

知识检索的8个步骤应该紧密配合，最终为用户提供准确、完整、易读的回答，充分利用数据建模阶段准备的向量库、倒排索引和知识图谱等多种数据源。
